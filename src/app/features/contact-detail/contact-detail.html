<div class="contact-detail-container">
  <app-header [title]="pageTitle()" [showContactsButton]="true" />

  @if (isLoading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <span class="loading-text">Loading contact...</span>
  </div>
  }

  @if (!isLoading() && (contact() || isNewContact())) {
  <div class="action-bar">
    @if (isViewMode()) {
    <button class="btn" [class.btn-favorite]="contact()?.isFavorite" [class.btn-outline]="!contact()?.isFavorite"
      (click)="onToggleFavorite()" [title]="contact()?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'">
      <span class="btn-icon">{{ contact()?.isFavorite ? '‚≠ê' : '‚òÜ' }}</span>
      <span class="btn-text">{{ contact()?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites' }}</span>
    </button>
    }

    @if (isViewMode()) {
    <button class="btn btn-primary" (click)="onEdit()" title="Edit contact">
      <span class="btn-icon">‚úèÔ∏è</span>
      <span class="btn-text">Edit</span>
    </button>
    }

    @if (isViewMode()) {
    <button class="btn btn-danger" (click)="onDelete()" [disabled]="isSaving()"
      [title]="isSaving() ? 'Deleting...' : 'Delete contact'">
      <span class="btn-icon">üóëÔ∏è</span>
      <span class="btn-text">
        @if (isSaving()) {
        Deleting...
        } @else {
        Delete
        }
      </span>
    </button>
    }

    @if (isEditing()) {
    <button class="btn btn-outline" (click)="onCancel()" title="Cancel editing">
      <span class="btn-icon">‚úï</span>
      <span class="btn-text">Cancel</span>
    </button>

    <button class="btn btn-primary" (click)="onSave()" [disabled]="!canSave() || isSaving()"
      [title]="isSaving() ? 'Saving...' : canSave() ? 'Save contact' : 'Make changes to enable save'">
      <span class="btn-icon">üíæ</span>
      <span class="btn-text">
        @if (isSaving()) {
        Saving...
        } @else {
        Save
        }
      </span>
    </button>
    }
  </div>
  }

  @if (!isLoading() && (contact() || isNewContact())) {
  <div class="contact-content">

    @if (!isEditing() && contact()) {
    <div class="contact-view">
      <div class="avatar-section">
        @if (shouldShowImage()) {
        <img [src]="contact()!.picture.large" [alt]="getContactFullName(contact()!)" class="avatar-large"
          (error)="onImageError()" (load)="onImageLoad()">
        } @else {
        <div class="avatar-large avatar-placeholder">
          {{ getContactFullName(contact()!).charAt(0).toUpperCase() }}
        </div>
        }
        @if (contact()!.pendingSync) {
        <div class="sync-badge">‚è≥ Pending Sync</div>
        }
      </div>

      <div class="info-section">
        <h2 class="contact-name">{{ getContactFullName(contact()!) }}</h2>

        <div class="info-groups">
          <div class="info-group">
            <h3 class="info-group-title">Personal Information</h3>
            <div class="info-items">
              <div class="info-item">
                <span class="info-label">üìß Email</span>
                <span class="info-value">{{ contact()!.email }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">üì± Phone</span>
                <span class="info-value">{{ contact()!.phone }}</span>
              </div>
              @if (contact()!.cell) {
              <div class="info-item">
                <span class="info-label">üìû Cell</span>
                <span class="info-value">{{ contact()!.cell }}</span>
              </div>
              }
              @if (contact()!.dob && contact()!.dob.age) {
              <div class="info-item">
                <span class="info-label">üéÇ Age</span>
                <span class="info-value">{{ contact()!.dob.age }} years old</span>
              </div>
              }
            </div>
          </div>

          @if (contact()!.location) {
          <div class="info-group">
            <h3 class="info-group-title">Address</h3>
            <div class="info-items">
              @if (contact()!.location.street && contact()!.location.street.name) {
              <div class="info-item">
                <span class="info-label">üè† Street</span>
                <span class="info-value">
                  @if (contact()!.location.street.number) {
                  {{ contact()!.location.street.number }}
                  }
                  {{ contact()!.location.street.name }}
                </span>
              </div>
              }
              <div class="info-item">
                <span class="info-label">üèôÔ∏è City</span>
                <span class="info-value">{{ contact()!.location.city }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">üèõÔ∏è State</span>
                <span class="info-value">{{ contact()!.location.state }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">üåç Country</span>
                <span class="info-value">{{ contact()!.location.country }}</span>
              </div>
              @if (contact()!.location.postcode) {
              <div class="info-item">
                <span class="info-label">üìÆ Postal Code</span>
                <span class="info-value">{{ contact()!.location.postcode }}</span>
              </div>
              }
            </div>
          </div>
          }

          @if (contact()!.registered && contact()!.registered.date) {
          <div class="info-group">
            <h3 class="info-group-title">Registration</h3>
            <div class="info-items">
              <div class="info-item">
                <span class="info-label">üìÖ Date</span>
                <span class="info-value">{{ contact()!.registered.date | date:'medium' }}</span>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    @if (isEditing()) {
    <form [formGroup]="contactForm" class="contact-form" (ngSubmit)="onSave()">

      <div class="form-section">
        <h3 class="form-section-title">Personal Information</h3>
        <div class="form-row">
          <div class="form-field">
            <label class="form-label">First Name *</label>
            <input type="text" formControlName="firstName" class="form-input"
              [class.invalid]="isFieldInvalid('firstName')" placeholder="Enter first name">
            @if (getFieldError('firstName')) {
            <span class="form-error">{{ getFieldError('firstName') }}</span>
            }
          </div>

          <div class="form-field">
            <label class="form-label">Last Name *</label>
            <input type="text" formControlName="lastName" class="form-input"
              [class.invalid]="isFieldInvalid('lastName')" placeholder="Enter last name">
            @if (getFieldError('lastName')) {
            <span class="form-error">{{ getFieldError('lastName') }}</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">Age (Optional)</label>
            <input type="number" formControlName="age" class="form-input" [class.invalid]="isFieldInvalid('age')"
              placeholder="Enter age" min="1" max="120">
            @if (getFieldError('age')) {
            <span class="form-error">{{ getFieldError('age') }}</span>
            }
          </div>

          <div class="form-field">
            <label class="form-label">Picture URL (Optional)</label>
            <input type="url" formControlName="picture" class="form-input" placeholder="Enter image URL">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">Contact Information</h3>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">Email *</label>
            <input type="email" formControlName="email" class="form-input" [class.invalid]="isFieldInvalid('email')"
              placeholder="Enter email address">
            @if (getFieldError('email')) {
            <span class="form-error">{{ getFieldError('email') }}</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">Phone *</label>
            <input type="tel" formControlName="phone" class="form-input" [class.invalid]="isFieldInvalid('phone')"
              placeholder="Enter phone number">
            @if (getFieldError('phone')) {
            <span class="form-error">{{ getFieldError('phone') }}</span>
            }
          </div>

          <div class="form-field">
            <label class="form-label">Cell (Optional)</label>
            <input type="tel" formControlName="cell" class="form-input" [class.invalid]="isFieldInvalid('cell')"
              placeholder="Enter cell number">
            @if (getFieldError('cell')) {
            <span class="form-error">{{ getFieldError('cell') }}</span>
            }
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">Address Information</h3>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">Street Address</label>
            <input type="text" formControlName="street" class="form-input" [class.invalid]="isFieldInvalid('street')"
              placeholder="Enter street address">
            @if (getFieldError('street')) {
            <span class="form-error">{{ getFieldError('street') }}</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">City</label>
            <input type="text" formControlName="city" class="form-input" [class.invalid]="isFieldInvalid('city')"
              placeholder="Enter city">
            @if (getFieldError('city')) {
            <span class="form-error">{{ getFieldError('city') }}</span>
            }
          </div>

          <div class="form-field">
            <label class="form-label">State/Province</label>
            <input type="text" formControlName="state" class="form-input" [class.invalid]="isFieldInvalid('state')"
              placeholder="Enter state/province">
            @if (getFieldError('state')) {
            <span class="form-error">{{ getFieldError('state') }}</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="form-label">Country</label>
            <input type="text" formControlName="country" class="form-input" [class.invalid]="isFieldInvalid('country')"
              placeholder="Enter country">
            @if (getFieldError('country')) {
            <span class="form-error">{{ getFieldError('country') }}</span>
            }
          </div>

          <div class="form-field">
            <label class="form-label">Postal Code</label>
            <input type="text" formControlName="postcode" class="form-input"
              [class.invalid]="isFieldInvalid('postcode')" placeholder="Enter postal code">
            @if (getFieldError('postcode')) {
            <span class="form-error">{{ getFieldError('postcode') }}</span>
            }
          </div>
        </div>
      </div>

    </form>
    }
  </div>
  }

  @if (!isLoading() && !contact() && !isNewContact()) {
  <div class="not-found">
    <div class="not-found-icon">üòï</div>
    <h2 class="not-found-title">Contact Not Found</h2>
    <p class="not-found-message">
      The contact you're looking for doesn't exist or may have been deleted.
    </p>
    <button class="btn btn-primary" (click)="onBack()">
      Go Back to Contacts
    </button>
  </div>
  }
</div>